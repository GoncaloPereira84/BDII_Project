{% extends "masterPage.html" %}

{% block title %}
Listar
{% endblock %}
{% load static %}
{% block links %}
<link rel="stylesheet" href="{% static 'assets/js/plugins/datatables-bs5/css/dataTables.bootstrap5.min.css'%}">
<link rel="stylesheet" href="{% static 'assets/js/plugins/datatables-buttons-bs5/css/buttons.bootstrap5.min.css'%}">

{% endblock %}

{% block content %}
<div class="content">
  <div class="block block-rounded">
    {% if table_name == "compra" %}
    <a href="/order/create/" class="btn btn-success mb-3 m-3 float-end"><i class="fa fa-fw fa-plus"></i>Nova
      encomenda</a>
    {% endif %}
    {% if table_name == "equipamento" %}
    <a href="/equipamento/create/" class="btn btn-success mb-3 m-3 float-end"><i class="fa fa-fw fa-plus"></i>Novo
      equipamento</a>
    {% endif %}
    <div class="block-header block-header-default">
      <h3 class="block-title">{{ table_name }}</small></h3>
      <div class="block-options">
        <button type="button" class="btn-block-option" data-toggle="block-option" data-action="state_toggle"
          data-action-mode="demo">
          <i class="si si-refresh"></i>
        </button>
        <div class="dropdown">
          <button type="button" class="btn-block-option" data-bs-toggle="dropdown" aria-haspopup="true"
            aria-expanded="false">
            <i class="si si-chemistry"></i>
          </button>
          <div class="dropdown-menu dropdown-menu-end">
            <a class="dropdown-item" href="javascript:void(0)">
              <i class="far fa-fw fa-dot-circle opacity-50 me-1"></i> Pending
            </a>
            <a class="dropdown-item" href="javascript:void(0)">
              <i class="far fa-fw fa-times-circle opacity-50 me-1"></i> Canceled
            </a>
            <a class="dropdown-item" href="javascript:void(0)">
              <i class="far fa-fw fa-check-circle opacity-50 me-1"></i> Completed
            </a>
            <div role="separator" class="dropdown-divider"></div>
            <a class="dropdown-item" href="javascript:void(0)">
              <i class="fa fa-fw fa-eye opacity-50 me-1"></i> View All
            </a>
          </div>
        </div>
      </div>
    </div>
    <div class="block-content block-content-full">
      <table class="table table-bordered table-striped table-vcenter js-dataTable-full">
        <thead>
          <tr>
            {% for column in columns %}
            <th class="d-none d-sm-table-cell">{{ column }}</th>
            {% endfor %}
            <th class="d-none d-sm-table-cell">ações</th>
          </tr>
        </thead>
        <tbody>
          {% for row in table_data %}
          <tr>
            {% if imagem_column_present and row.0 != 0 %}
            <td><img src="{{ row.0 }}" alt="Image" style="max-width: 40px; max-height: 40px;"></td>
            {% endif %}
            {% for i in row %}
            {% if forloop.first and imagem_column_present %}
            {% comment %} Skip the first iteration because image exits {% endcomment %}
            {% else %}
            <td>{{ i }}</td>
            {% endif %}
            {% endfor %}
            <td class="text-center d-flex align-items-center justify-content-center">
              {% if imagem_column_present %}
              <form method="post" action="{% url 'edit_record' table_name=table_name record_id=row.1 %}">
                {% csrf_token %}
                <button type="button" class="btn btn-sm btn-alt-secondary"
                  onclick="abrirModalDetalhesComponente('{{ row.1 }}', 'detalhes_componente')">
                  <i class="fa fa-eye"></i>
                </button>
                <button type="submit" class="btn btn-sm btn-alt-secondary" data-bs-toggle="tooltip" title="Edit">
                  <i class="fa fa-pencil-alt"></i>
                </button>
              </form>
              {% elif table_name == "compra"%}
              <form method="post" action="{% url 'edit_record' table_name=table_name record_id=row.0 %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-alt-secondary" data-bs-toggle="tooltip"
                  title="Detalhes encomenda">
                  <i class="text-primary fa fa-eye"></i>
                </button>
              </form>
              <button type="submit" class="btn btn-sm btn-alt-secondary" data-bs-toggle="tooltip"
                title="Receber encomenda" onclick="receberEncomenda('{{ row.0 }}')">
                <i class="text-success fa fa-cart-arrow-down"></i>
              </button>
              {% else%}
              <form method="post" action="{% url 'edit_record' table_name=table_name record_id=row.0 %}">
                {% csrf_token %}
                <button type="button" class="btn btn-sm btn-alt-secondary"
                  onclick="abrirModalDetalhesFornecedor('{{ row.0 }}', 'detalhes_fornecedor')">
                  <i class="fa fa-eye"></i>
                </button>

                <button type="submit" class="btn btn-sm btn-alt-secondary" data-bs-toggle="tooltip" title="Editar">
                  <i class="fa fa-pencil-alt"></i>
                </button>
              </form>
              {% endif %}
              <button type="button" class="btn btn-sm btn-alt-secondary ms-1" data-bs-toggle="tooltip" title="Eliminar"
                onclick="confirmDelete('{{ table_name }}', '{{ row.0 }}')">
                <i class="fa fa-times"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function confirmDelete(tableName, recordId) {
    if (confirm('Tem certeza de que deseja excluir este registo?')) {
      window.location.href = `/delete_record/${tableName}/${recordId}/`;
    }
  }

  function receberEncomenda(recordId) {
    if (confirm('Tem certeza de que deseja receber a encomenda?')) {
      window.location.href = `/receive_order/${recordId}/`;
    }
  }

  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        // Procura por ocorrências de 'name=' no início do cookie
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function abrirModalDetalhes(tipo, id, tableName, response) {
    const corEstado = response.estado === 'Ativo' ? 'green' : 'red';
    console.log(response.pcusto_medio);

    // Verificar se o campo de preço existe e não está vazio (para componentes)
    const precoNumerico = response.preco ? parseFloat(response.preco.replace(/[^\d.]/g, '')) : 0;
    const precoMNumerico = response.pcusto_medio ? parseFloat(response.pcusto_medio.replace(/[^\d.]/g, '')) : 0;

    // Verificar se o preço é um número válido
    if (!isNaN(precoNumerico) || !isNaN(precoMNumerico)) {
      // Formatar o preço como string de moeda Euro
      const precoFormatado = new Intl.NumberFormat('pt-PT', {
        style: 'currency',
        currency: 'EUR'
      }).format(precoNumerico);

      const precoMFormatado = new Intl.NumberFormat('pt-PT', {
        style: 'currency',
        currency: 'EUR'
      }).format(precoMNumerico);

      Swal.fire({
        title: `Detalhes ${tipo === 'fornecedor' ? 'do Fornecedor' : 'do Componente'}`,
        html: `
            <table class="table">
                <tbody>
                    ${tipo === 'fornecedor' ? `
                    <tr>
                                <th class="text-end">Nome:</th>
                                <td class="text-start">${response.nome}</td>
                            </tr>
                            <tr>
                                <th class="text-end">Email:</th>
                                <td class="text-start">${response.email}</td>
                            </tr>
                            <tr>
                                <th class="text-end">Contacto:</th>
                                <td class="text-start">${response.contacto}</td>
                            </tr>
                            <tr>
                                <th class="text-end">Endereço:</th>
                                <td class="text-start">${response.endereco}</td>
                            </tr>
                            <tr>
                                <th class="text-end">Código Postal:</th>
                                <td class="text-start">${response.codigopostal}</td>
                            </tr>
                            <tr>
                                <th class="text-end">Localidade:</th>
                                <td class="text-start">${response.localidade}</td>
                            </tr>   
                            <tr>
                                <th class="text-end" style="color: ${corEstado}">Estado:</th>
                                <td class="text-start" style="color: ${corEstado}">${response.estado}</td>
                            </tr>
     
                    ` : ''}   
                    ${tipo === 'componente' ? `
                    <table class="table" style="width: 100%;">
                      <tbody>
                          <tr>
                            <td class="text-center" style="vertical-align: middle;">
                                <img src="${response.imagem}" alt="Imagem" style="max-width: 100%; max-height: 100px; vertical-align: middle;">
                            </td>

                            <td class="text-start" style="padding-top: 5px; padding-left: 20px; vertical-align: middle;">
                                <div style="margin-bottom: 10px;">
                                    <strong>Nome:</strong> ${response.descricao}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Preço:</strong> ${precoFormatado}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Custo médio:</strong> ${precoMFormatado}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Stock:</strong> 
                                    <span style="color: ${response.quantidade_stock > 20 ? 'green' : (response.quantidade_stock > 10 ? 'orange' : 'red')}">
                                        ${response.quantidade_stock}
                                    </span>
                                </div>
                            </td>
                          </tr>
                          


                      </tbody>
                    </table>
                    <tr>
                        <td class="text-start" style="padding-top: 20px; align-items: center;">
                            <strong>Estado:</strong>
                            <span style="color: ${corEstado};">${response.estado}</span>
                        </td>
                    </tr>


                    ` : ''}   
                    
                </tbody>
            </table>
        `,
        showCloseButton: true,
        showCancelButton: false,
        focusConfirm: false,
        width: '40%',
      });
    } else {
      console.error('O valor do preço não é um número válido.');
    }
  }


  function abrirModalDetalhesFornecedor(id, tableName) {
    console.log(id, tableName);
    $.ajax({
      url: `/${tableName}/${id}/`,
      method: 'POST', // ou 'GET' dependendo da sua configuração
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      dataType: 'json',
      success: function (response) {
        console.log(response);
        abrirModalDetalhes('fornecedor', id, tableName, response);
      },
      error: function (error) {
        console.error(`Erro ao obter detalhes do fornecedor (${tableName}):`, error);
      }
    });
  }

  // Exemplo de uso para componente
  function abrirModalDetalhesComponente(id, tableName) {
    $.ajax({
      url: `/${tableName}/${id}/`,
      method: 'POST', // ou 'GET' dependendo da sua configuração
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      dataType: 'json',
      success: function (response) {
        abrirModalDetalhes('componente', id, tableName, response);
      },
      error: function (error) {
        console.error(`Erro ao obter detalhes do componente (${tableName}):`, error);
      }
    });
  }
  // Adicione um listener de evento ao botão de detalhes

</script>

<!-- jQuery (required for DataTables plugin) -->
<script src="{% static 'assets/js/lib/jquery.min.js'%}"></script>

<!-- Page JS Plugins -->
<script src="{% static 'assets/js/plugins/datatables/jquery.dataTables.min.js'%}"></script>
<script src="{% static 'assets/js/plugins/datatables-bs5/js/dataTables.bootstrap5.min.js'%}"></script>
<script src="{% static 'assets/js/plugins/datatables-buttons/dataTables.buttons.min.js'%}"></script>
<script src="{% static 'assets/js/plugins/datatables-buttons-bs5/js/buttons.bootstrap5.min.js'%}"></script>
<script src="{% static 'assets/js/plugins/datatables-buttons-jszip/jszip.min.js'%}"></script>
<script src="{% static 'assets/js/plugins/datatables-buttons-pdfmake/pdfmake.min.js'%}"></script>
<script src="{% static 'assets/js/plugins/datatables-buttons-pdfmake/vfs_fonts.js'%}"></script>
<script src="{% static 'assets/js/plugins/datatables-buttons/buttons.print.min.js'%}"></script>
<script src="{% static 'assets/js/plugins/datatables-buttons/buttons.html5.min.js'%}"></script>
<script src="{% static 'assets/js/plugins/sweetalert2/sweetalert2.js'%}"></script>
<script src="{% static 'assets/js/plugins/sweetalert2/sweetalert2.css'%}"></script>
<script src="{% static 'assets/js/plugins/sweetalert2/sweetalert2.all.js'%}"></script>

<script src="{% static 'assets/js/pages/be_tables_datatables.min.js'%}"></script>

{% endblock %}