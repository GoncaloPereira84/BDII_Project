{% load static %}
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">

  <title>{% block title %}{% endblock %}</title>


  <meta name="description"
    content="Dashmix - Bootstrap 5 Admin Template &amp; UI Framework created by pixelcave and published on Themeforest">
  <meta name="author" content="pixelcave">
  <meta name="robots" content="noindex, nofollow">

  <meta property="og:title" content="Dashmix - Bootstrap 5 Admin Template &amp; UI Framework">
  <meta property="og:site_name" content="Dashmix">
  <meta property="og:description"
    content="Dashmix - Bootstrap 5 Admin Template &amp; UI Framework created by pixelcave and published on Themeforest">
  <meta property="og:type" content="website">
  <meta property="og:url" content="">
  <meta property="og:image" content="">
  <link rel="shortcut icon" href="{% static 'assets/media/favicons/favicon.png'%}">
  <link rel="icon" type="image/png" sizes="192x192" href="{% static 'assets/media/favicons/favicon-192x192.png'%}">
  <link rel="apple-touch-icon" sizes="180x180" href="{% static 'assets/media/favicons/apple-touch-icon-180x180.png'%}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.3/dist/sweetalert2.min.css">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" id="css-main" href="{% static 'assets/css/dashmix.min.css'%}">
  <link rel="stylesheet" id="css-theme" href="{% static 'assets/css/themes/xwork.min.css'%}">
  {% block links %}{% endblock %}

</head>

<body>
  <main id="main-container">
    <div id="page-container"
      class="enable-page-overlay side-scroll page-header-dark page-header-glass main-content-boxed">
      <!-- Side Overlay-->
      <aside id="side-overlay">
        <!-- Side Header -->
        <div class="bg-primary">
          <div class="content-header">
            <!-- User Avatar -->
            {% if request.session.id_utilizador %}
            <button type="button" class="btn btn-alt-secondary" id="page-header-user-dropdown" data-bs-toggle="dropdown"
              aria-haspopup="true" aria-expanded="false">
              <i class="fa fa-fw fa-user d-sm-none"></i>
              <span class="d-none d-sm-inline-block">{{ request.session.nome }}</span>
              <i class="fa fa-fw fa-angle-down opacity-50 ms-1 d-none d-sm-inline-block"></i>
            </button>
            <div class="dropdown-menu dropdown-menu-end p-0" aria-labelledby="page-header-user-dropdown">
              <div class="bg-primary-dark rounded-top fw-semibold text-white text-center p-2">
                Opções
              </div>
              <div class="p-2">
                <a class="dropdown-item" href="/logout">
                  <i class="far fa-fw fa-arrow-alt-circle-left me-1"></i> Sign Out
                </a>
              </div>
            </div>
            {% else %}
            <button type="button" class="btn btn-alt-secondary" id="page-header-user-dropdown" onclick="login()">
              <i class="fa fa-fw fa-user d-sm-none"></i>
              <span class="d-none d-sm-inline-block">Iniciar Sessão</span>
            </button>
            {% endif %}
            <!-- END User Info -->

            <!-- Close Side Overlay -->
            <!-- Layout API, functionality initialized in Template._uiApiLayout() -->
            <a class="ms-auto text-white" href="javascript:void(0)" data-toggle="layout"
              data-action="side_overlay_close">
              <i class="fa fa-times-circle"></i>
            </a>
            <!-- END Close Side Overlay -->
          </div>
        </div>
        <!-- END Side Header -->

        <!-- Side Navigation -->
        <div class="content-side content-side-full">
          <ul class="nav-main">
            {% if request.session.id_utilizador and request.session.id_perfil != 1 %}
            <li class="nav-main-item">
              <a class="nav-main-link active" href="/dashboard/">
                <i class="nav-main-link-icon fa fa-coffee"></i>
                <span class="nav-main-link-name">Dashboard</span>
              </a>
            </li>
            {% endif %}
            {% if request.session.id_utilizador %}
            <li class="nav-main-item">
              <a class="nav-main-link" href="/usercompras/">
                <i class="nav-main-link-icon fa fa-rocket"></i>
                <span class="nav-main-link-name">Minhas Compras</span>
              </a>
            </li>
            <li class="nav-main-item">
              <a class="nav-main-link" href="">
                <i class="nav-main-link-icon fa fa-user"></i>
                <span class="nav-main-link-name">Perfil</span>
              </a>
            </li>
            {% endif %}
          </ul>
        </div>
        <!-- END Side Navigation -->
      </aside>
      <header id="page-header">
        <div class="content-header">
          <div>
            <a class="fw-semibold tracking-wide" style="color: black;" href="/">
              BDTech
            </a>
          </div>

          <div id="Cartbutton">
            {% if request.session.id_utilizador %}
            <button type="button" class="btn btn-sm btn-alt-secondary" id="page-header-cart-dropdown"
              data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            </button>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="page-header-cart-dropdown" id="carrinho_div">
              <div class="bg-primary-dark rounded-top fw-semibold text-white text-center p-2">
                Carrinho <span id="total-preco"></span>
              </div>
              <div id="carrinho-container">
                <!-- linhas do carrinho -->
              </div>
              <div id="finalizar-container" class="text-center">
              </div>
            </div>
            {% endif %}
            <button type="button" class="btn btn-sm btn-alt-secondary" data-toggle="layout"
              data-action="side_overlay_toggle">
              <i class="fa fa-fw fa-bars"></i>
            </button>
          </div>

        </div>
        <div id="page-header-search" class="overlay-header bg-header-dark">
          <div class="content-header">
            <form class="w-100" action="be_pages_generic_search.html" method="POST">
              <div class="input-group">
                <input type="text" class="form-control" placeholder="Search or hit ESC.." id="page-header-search-input"
                  name="page-header-search-input">
                <button type="button" class="btn btn-alt-secondary" data-toggle="layout"
                  data-action="header_search_off">
                  <i class="fa fa-fw fa-times-circle"></i>
                </button>
              </div>
            </form>
          </div>
        </div>

        <div id="page-header-loader" class="overlay-header bg-header-dark">
          <div class="content-header">
            <div class="w-100 text-center">
              <i class="fa fa-fw fa-2x fa-sun fa-spin"></i>
            </div>
          </div>
        </div>
      </header>
      <div class="content">
        <div class="bg-body-extra-light mt-5">
          <div class="content py-3">
            <ul class="nav nav-pills justify-content-center justify-content-md-start">
              <li class="nav-item me-3">
                <a class="nav-link" href="/tipo/1">
                  <i class="fa fa-laptop"></i> <span class="d-none d-md-inline ms-1">Portáteis</span>
                </a>
              </li>
              <li class="nav-item me-3">
                <a class="nav-link" href="/tipo/2">
                  <i class="fa fa-desktop"></i> <span class="d-none d-md-inline ms-1">Desktops</span>
                </a>
              </li>
              {% if request.session.id_utilizador %}
              <li class="nav-item ms-md-auto">
                <a class="nav-link" href="/usercompras/">
                  <i class="fa fa-star text-warning fa-fw"></i> <span class="d-none d-md-inline ms-1">Minhas
                    Compras</span>
                </a>
              </li>
              {% endif %}
            </ul>
          </div>
        </div>
        {% block content %}
        {% endblock %}
      </div>
  </main>


  <footer id="page-footer" class="bg-body-light">
    <div class="content py-0">
      <div class="row fs-sm">
        <div class="col-sm-6 order-sm-1 text-center text-sm-start">
          <a class="fw-semibold" href="https://1.envato.market/r6y" target="_blank">BDTech</a> &copy; <span
            data-toggle="year-copy"></span>
        </div>
      </div>
    </div>
  </footer>

  <script src="{% static 'assets/js/dashmix.app.min.js'%}"></script>

  <!-- jQuery (required for jQuery Sparkline plugin) -->
  <script src="{% static 'assets/js/lib/jquery.min.js'%}"></script>

  <!-- Page JS Plugins -->
  <script src="{% static 'assets/js/plugins/jquery-sparkline/jquery.sparkline.min.js'%}"></script>

  <!-- Page JS Helpers (jQuery Sparkline Plugin) -->
  <script>Dashmix.helpersOnLoad('jq-sparkline');</script>

  <script>
    $(document).ready(function () {
      $('#page-header-cart-dropdown').click(function () {
        $.ajax({
          type: 'GET',
          url: '/get_carrinho_data/',
          success: function (data) {
            $('#carrinho-container').empty();
            $('#finalizar-container').remove();
            if (data) {
              if (data.length - 1 == 0) {
                $('#carrinho-container').append(`<p class="text-center">Vazio</p>`);
                $('#total-preco').text('');
              } else {
                var tabela = document.createElement('table');
                tabela.classList.add('table', 'table-bordered');

                for (var i = 0; i < data.length - 1; i++) {
                  var item = data[i];
                  var textoFormatado = item.nome.length > 10 ? item.nome.substring(0, 10) + '...' : item.nome;

                  var novaLinha = document.createElement('tr');
                  novaLinha.innerHTML = `
                                <td class="text-center">
                                  <img src="${item.imagem}" alt="${item.nome}" class="img-fluid rounded" style="max-width: 75px;">
                                </td>
                                <td class="text-center">
                                  <a class="mt-4" href="/equipamento/${item.id_equipamento}">${textoFormatado} </a>
                                </td>
                                <td class="text-center">
                                  <p class="mt-4">${item.quantidade}</p>
                                </td>
                                <td class="text-center">
                                  {% csrf_token %}
                                  <button class="btn btn-sm" style="color:gray; background-color: transparent; border: none;" onclick="changeQuantidade(${item.id_equipamento},0,1)"><i class="fa fa-minus"></i></button>
                                </td>
                                <td class="text-center">
                                  {% csrf_token %}
                                  <button class="btn btn-sm" style="color:gray; background-color: transparent; border: none;" onclick="changeQuantidade(${item.id_equipamento},1,1)"><i class="fa fa-plus"></i></button>
                                </td>
                                <td class="text-center">
                                  <p class="mt-4">${item.preco}€</p>
                                </td>
                                <td class="text-center">
                                  {% csrf_token %}
                                  <button class="btn btn-sm" style="color:red; background-color: transparent; border: none;" onclick="removerDoCarrinho(${item.id_equipamento},1)"><i class="fa fa-trash"></i></button>
                                </td>
                                `;
                  tabela.appendChild(novaLinha);
                }

                $('#carrinho-container').append(tabela);
                $('#total-preco').text('- Total: ' + data[data.length - 1].total_preco + '€');
                $('#carrinho_div').append('<div id="finalizar-container" class="text-center"><a class="text-center" href="/finalizarCarrinho">Finalizar Compra</a></div>');
                atualizarNumeroCarrinho();
              }
            }
          },
          error: function () {
            Swal.fire({
              icon: 'error',
              title: 'Erro',
              text: 'Erro ao obter os dados do carrinho.',
            });
          }
        });
      });
    });

    function atualizarNumeroCarrinho() {
      $.ajax({
        type: 'GET',
        url: '/get_carrinho_data/',
        success: function (data) {
          if (data) {
            if (data.length - 1 == 0) {
              $('#page-header-cart-dropdown').html(`<i class="fa fa-cart-plus"></i> ${data.length - 1}`);
            } else {
              $('#page-header-cart-dropdown').html(`<i class="fa fa-cart-plus"></i> ${data.length - 1}`);
            }
          }
        },
        error: function () {
          Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Erro ao obter os dados do carrinho.',
          });
        }
      });
    }

    $(document).ready(function () {
      $('#Cartbutton').ready(function () {
        $.ajax({
          type: 'GET',
          url: '/get_carrinho_data/',
          success: function (data) {
            if (data) {
              if (data.length - 1 == 0) {
                atualizarNumeroCarrinho();
              } else {
                atualizarNumeroCarrinho();
              }
            }
          },
          error: function () {
            Swal.fire({
              icon: 'error',
              title: 'Erro',
              text: 'Erro ao obter os dados do carrinho.',
            });
          }
        });
      });
    });


    function removerDoCarrinho(itemId, tipo_click) {
      var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
      var requestData = {
        'id_equipamento': itemId,
        'csrfmiddlewaretoken': csrfToken
      };

      $.ajax({
        type: 'POST',
        url: '/remover_do_carrinho/',
        data: requestData,
        success: function (response) {
          if (tipo_click == 1) {
            $('#page-header-cart-dropdown').click();
          }
          atualizarNumeroCarrinho();
          atualizarTotalCarrinho();
        },
        error: function () {
          Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Erro ao remover o item do carrinho.',
          });
        }
      });
    }

    function changeQuantidade(itemId, tipo, tipo_click) {
      var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
      var requestData = {
        'id_equipamento': itemId,
        'tipo': tipo,
        'csrfmiddlewaretoken': csrfToken
      };

      $.ajax({
        type: 'POST',
        url: '/mudar_quantidade_carrinho/',
        data: requestData,
        success: function (response) {
          if (tipo_click == 1) {
            $('#page-header-cart-dropdown').click();
          }
          atualizarNumeroCarrinho();
          atualizarTotalCarrinho();
        },
        error: function () {
          Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Erro a mudar quantidade no carrinho.',
          });
        }
      });
    }
  </script>

  <script>
    function login() {
      window.location.href = "/fulllogin";
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.3/dist/sweetalert2.all.min.js"></script>

  <!--load scripts-->
  {% block scripts %}

  {% endblock %}

</body>

</html>